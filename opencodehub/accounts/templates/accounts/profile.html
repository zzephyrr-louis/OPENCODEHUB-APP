{% extends 'accounts/home_base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }}'s Profile - OpenCodeHub{% endblock %}

{% block extra_css %}
<style>
    /* Profile Page Custom Styles - Updated for UI Consistency */
    .profile-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    /* Profile Header Card - Matching project-header-card style */
    .profile-header {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        margin-bottom: 2rem;
        border: 1px solid rgba(102, 126, 234, 0.1);
        transition: all 0.4s ease;
        display: flex;
        gap: 32px;
        align-items: flex-start;
        transition: all 0.3s ease;
    }

    .profile-header-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .profile-header:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 32px rgba(102, 126, 234, 0.15);
        border-color: rgba(102, 126, 234, 0.3);
    }

    .profile-picture-section {
        flex-shrink: 0;
        position: relative;
    }

    .profile-picture {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
          border: 4px solid rgba(102, 126, 234, 0.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .profile-info-section {
        flex: 1;
    }

    .profile-name {
        font-size: 2rem;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 1rem;
    }

    .profile-username {
        font-size: 18px;
        color: #86868b;
        margin-bottom: 16px;
    }

    .profile-bio {
        font-size: 16px;
        color: #515154;
        line-height: 1.6;
        margin-bottom: 24px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        border-left: 4px solid #667eea;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 24px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .stat-icon {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.9;
    }

    .stat-number {
        font-size: 36px;
        font-weight: 700;
        color: #667eea;
        display: block;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Edit Profile Button */
    .edit-profile-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .edit-profile-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    /* Projects Section - Matching card style */
    .projects-section {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .section-title {
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }

    /* Project Card - Matching my_projects style */
    .project-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e5e5e5;
        text-decoration: none;
        color: inherit;
        display: block;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .project-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .project-card:hover::before {
        transform: scaleX(1);
    }

    .project-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
    }

    .project-title {
        font-size: 20px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }

    .project-description {
        font-size: 14px;
        color: #86868b;
        line-height: 1.5;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .no-projects {
        text-align: center;
        padding: 60px 20px;
        color: #86868b;
    }

    .no-projects i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Edit Profile Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .modal-header {
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        font-size: 16px;
        background: white;
        transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 120px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
    }

    .btn-cancel {
        padding: 14px 28px;
        border: 2px solid #e5e5e5;
        background: white;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel:hover {
        background: #f8f9fa;
        border-color: #86868b;
    }

    .btn-save {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    .profile-picture-upload {
        margin-top: 16px;
    }

    .current-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 16px;
        border: 4px solid #f0f0f0;
    }

    .picture-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 12px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .profile-header-card {
            flex-direction: column;
            text-align: center;
        }

        .profile-info-section {
            align-items: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .projects-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Back Button -->
    <a href="{% url 'home' %}" class="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg);">
            <path d="M17.92 11.62C17.8724 11.4973 17.801 11.3851 17.71 11.29L12.71 6.29C12.6168 6.19676 12.5061 6.1228 12.3842 6.07234C12.2624 6.02188 12.1319 5.99591 12 5.99591C11.7337 5.99591 11.4783 6.1017 11.29 6.29C11.1968 6.38324 11.1228 6.49393 11.0723 6.61575C11.0219 6.73758 10.9959 6.86814 10.9959 7C10.9959 7.2663 11.1017 7.5217 11.29 7.71L14.59 11H7C6.73478 11 6.48043 11.1054 6.29289 11.2929C6.10536 11.4804 6 11.7348 6 12C6 12.2652 6.10536 12.5196 6.29289 12.7071C6.48043 12.8946 6.73478 13 7 13H14.59L11.29 16.29C11.1963 16.383 11.1219 16.4936 11.0711 16.6154C11.0203 16.7373 10.9942 16.868 10.9942 17C10.9942 17.132 11.0203 17.2627 11.0711 17.3846C11.1219 17.5064 11.1963 17.617 11.29 17.71C11.383 17.8037 11.4936 17.8781 11.6154 17.9289C11.7373 17.9797 11.868 18.0058 12 18.0058C12.132 18.0058 12.2627 17.9797 12.3846 17.9289C12.5064 17.8781 12.617 17.8037 12.71 17.71L17.71 12.71C17.801 12.6149 17.8724 12.5028 17.92 12.38C18.02 12.1365 18.02 11.8635 17.92 11.62Z" fill="currentColor"/>
        </svg>
        Back to Home
    </a>

    <!-- Profile Header -->
    <div class="profile-header-card">
        <div class="profile-picture-section">
            <img src="{{ profile_user.get_profile_picture_url }}" alt="{{ profile_user.username }}" class="profile-picture">
        </div>
        
        <div class="profile-info-section">
            <h1 class="profile-name">
                {% if profile_user.first_name or profile_user.last_name %}
                    {{ profile_user.first_name }} {{ profile_user.last_name }}
                {% else %}
                    {{ profile_user.username }}
                {% endif %}
            </h1>
            <div class="profile-username">@{{ profile_user.username }}</div>
            
            {% if profile_user.bio %}
            <div class="profile-bio">
                <i class="fas fa-quote-left" style="opacity: 0.3; margin-right: 8px;"></i>
                {{ profile_user.bio }}
            </div>
            {% endif %}
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <span class="stat-number">{{ formatted_upload_count }}</span>
                    <span class="stat-label">Total Uploads</span>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <span class="stat-number">{{ total_projects }}</span>
                    <span class="stat-label">Active Projects</span>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-code-branch"></i>
                    </div>
                    <span class="stat-number">{{ total_versions }}</span>
                    <span class="stat-label">Versions</span>
                </div>
            </div>
            
            {% if is_own_profile %}
            <button class="edit-profile-btn" onclick="openEditModal()">
                <i class="fas fa-edit"></i> Edit Profile
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Public Projects Section -->
    <div class="projects-section">
        <h2 class="section-title">
            <i class="fas fa-globe"></i>
            Public Projects
        </h2>
        
        {% if public_projects %}
        <div class="projects-grid">
            {% for project in public_projects %}
            <a href="{% url 'project_detail' project.id %}" class="project-card">
                <div class="project-icon">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="project-title">{{ project.title }}</div>
                <div class="project-description">{{ project.description|default:"No description" }}</div>
                <div style="margin-top: 12px; font-size: 12px; color: #86868b;">
                    <i class="fas fa-clock"></i> {{ project.updated_at|timesince }} ago
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-projects">
            <i class="fas fa-folder-open"></i>
            <h3 style="margin-bottom: 8px;">No public projects yet</h3>
            <p>{% if is_own_profile %}Make some of your projects public to share them here{% else %}This user hasn't shared any projects publicly{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Profile Modal -->
{% if is_own_profile %}
<div id="editModal" class="modal">
    <div class="modal-content">
        <h2 class="modal-header">
            <i class="fas fa-user-edit"></i> Edit Profile
        </h2>
        
        <form method="POST" action="{% url 'update_profile' %}" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
                <label><i class="fas fa-image"></i> Profile Picture</label>
                <img src="{{ user.get_profile_picture_url }}" alt="Current" class="current-picture">
                <input type="file" name="profile_picture" accept="image/*" class="profile-picture-upload">
                {% if user.profile_picture %}
                <div class="picture-actions">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="remove_picture" value="true" style="width: 18px; height: 18px;">
                        <span>Remove current picture</span>
                    </label>
                </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="first_name"><i class="fas fa-user"></i> First Name</label>
                <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" placeholder="Enter your first name">
            </div>
            
            <div class="form-group">
                <label for="last_name"><i class="fas fa-user"></i> Last Name</label>
                <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" placeholder="Enter your last name">
            </div>
            
            <div class="form-group">
                <label for="bio"><i class="fas fa-pen"></i> Bio</label>
                <textarea id="bio" name="bio" placeholder="Tell us about yourself...">{{ user.bio }}</textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeEditModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openEditModal() {
    document.getElementById('editModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

// Close modal with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('show')) {
        closeEditModal();
    }
});
</script>
{% endif %}
{% endblock %}