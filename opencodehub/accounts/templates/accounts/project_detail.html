{% extends 'accounts/base.html' %}
{% load project_permissions %}
{% block content %}
<div class="container mt-4">
  <!-- Back Button -->
  <div class="mb-4">
    <a href="javascript:history.back()" class="cs-button-6" aria-label="go back">
      <!--SVG Arrow (flipped for back)-->
      <svg class="cs-icon" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg);">
        <path d="M17.92 11.62C17.8724 11.4973 17.801 11.3851 17.71 11.29L12.71 6.29C12.6168 6.19676 12.5061 6.1228 12.3842 6.07234C12.2624 6.02188 12.1319 5.99591 12 5.99591C11.7337 5.99591 11.4783 6.1017 11.29 6.29C11.1968 6.38324 11.1228 6.49393 11.0723 6.61575C11.0219 6.73758 10.9959 6.86814 10.9959 7C10.9959 7.2663 11.1017 7.5217 11.29 7.71L14.59 11H7C6.73478 11 6.48043 11.1054 6.29289 11.2929C6.10536 11.4804 6 11.7348 6 12C6 12.2652 6.10536 12.5196 6.29289 12.7071C6.48043 12.8946 6.73478 13 7 13H14.59L11.29 16.29C11.1963 16.383 11.1219 16.4936 11.0711 16.6154C11.0203 16.7373 10.9942 16.868 10.9942 17C10.9942 17.132 11.0203 17.2627 11.0711 17.3846C11.1219 17.5064 11.1963 17.617 11.29 17.71C11.383 17.8037 11.4936 17.8781 11.6154 17.9289C11.7373 17.9797 11.868 18.0058 12 18.0058C12.132 18.0058 12.2627 17.9797 12.3846 17.9289C12.5064 17.8781 12.617 17.8037 12.71 17.71L17.71 12.71C17.801 12.6149 17.8724 12.5028 17.92 12.38C18.02 12.1365 18.02 11.8635 17.92 11.62Z" fill="currentColor"/>
      </svg>
      Back
    </a>
  </div>

  <!-- Project Header -->
  <div class="project-header-card">
    <h2>{{ project.title }}</h2>
    <p class="text-muted">{{ project.description }}</p>
    <div class="project-meta">
      <span class="badge bg-secondary">
        <i class="fas fa-user"></i> {{ project.owner.username }}
      </span>
      {% if project.is_public %}
        <span class="badge bg-success">
          <i class="fas fa-globe"></i> Public
        </span>
      {% else %}
        <span class="badge bg-warning">
          <i class="fas fa-lock"></i> Private
        </span>
      {% endif %}
    </div>
  </div>

  <!-- Share Section (Only visible to project owner) -->
  {% if project.owner == user %}
  <div class="share-section card shadow-sm mb-4" style="border-radius: 15px;">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-share-alt text-primary"></i> Share Project
      </h5>
      
      <!-- Shareable Link Section -->
      <div class="shareable-link-section mb-4 p-3" style="background: #f8f9fa; border-radius: 12px;">
        <h6 class="mb-2">
          <i class="fas fa-link text-success"></i> Public Shareable Link
        </h6>
        <p class="text-muted small mb-3">Anyone with this link can view your project</p>
        
        {% if project.share_link %}
        <div class="input-group mb-2">
          <input 
            type="text" 
            id="shareableLink" 
            class="form-control" 
            value="{{ request.scheme }}://{{ request.get_host }}{% url 'view_shared_project' project.share_link %}" 
            readonly
            style="border-radius: 12px 0 0 12px; font-family: monospace; font-size: 0.9em;"
          >
          <button 
            class="btn btn-success" 
            onclick="copyShareLink(event)"
            style="border-radius: 0 12px 12px 0;"
          >
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
        <form method="POST" action="{% url 'generate_share_link' project.id %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="regenerate" value="true">
          <button type="submit" class="btn btn-sm btn-outline-warning" style="border-radius: 8px;">
            <i class="fas fa-sync-alt"></i> Regenerate Link
          </button>
        </form>
        {% else %}
        <form method="POST" action="{% url 'generate_share_link' project.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success" style="border-radius: 12px;">
            <i class="fas fa-link"></i> Generate Shareable Link
          </button>
        </form>
        {% endif %}
      </div>
      
      <hr class="my-4">
      
      <p class="text-muted small mb-3">Or share with specific users by entering their username or email</p>
      
      <!-- Share Form -->
      <form method="POST" action="{% url 'share_project' project.id %}" class="mb-3">
        {% csrf_token %}
        <div class="mb-3">
          <input 
            type="text" 
            name="share_with" 
            class="form-control" 
            placeholder="Enter username or email..."
            style="border-radius: 12px;"
            required
          >
        </div>
        <div class="d-flex gap-2 mb-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="permission" id="viewPermission" value="view" checked>
            <label class="form-check-label" for="viewPermission">
              <i class="fas fa-eye text-info"></i> View Only
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="permission" id="editPermission" value="edit">
            <label class="form-check-label" for="editPermission">
              <i class="fas fa-edit text-success"></i> Can Edit
            </label>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100" style="border-radius: 12px;">
          <i class="fas fa-paper-plane"></i> Share Project
        </button>
      </form>
      
      <!-- List of people project is shared with -->
      {% if project.shared_users.all %}
      <div class="shared-users-list">
        <h6 class="mb-3">
          <i class="fas fa-users text-success"></i> Shared with ({{ project.shared_users.all.count }})
        </h6>
        <ul class="list-group">
          {% for shared in project.shared_users.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center" style="border-radius: 10px; margin-bottom: 8px;">
            <div class="d-flex align-items-center gap-2">
              <div class="user-avatar-small">
                {{ shared.user.first_name.0|upper }}{{ shared.user.last_name.0|upper }}
              </div>
              <div>
                <strong>{{ shared.user.first_name }} {{ shared.user.last_name }}</strong>
                <br>
                <small class="text-muted">@{{ shared.user.username }}</small>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% if shared.permission == 'edit' %}
                <span class="badge bg-success" style="border-radius: 8px;">
                  <i class="fas fa-edit"></i> Can Edit
                </span>
              {% else %}
                <span class="badge bg-info" style="border-radius: 8px;">
                  <i class="fas fa-eye"></i> View Only
                </span>
              {% endif %}
              <a href="{% url 'unshare_project' project.id shared.user.id %}" 
                class="btn btn-sm btn-outline-danger"
                style="border-radius: 8px;"
                onclick="return confirm('Remove {{ shared.user.username }} from this project?')">
                <i class="fas fa-times"></i> Remove
              </a>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <div class="alert alert-info" role="alert" style="border-radius: 12px;">
        <i class="fas fa-info-circle"></i> This project is not shared with anyone yet.
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Files Section -->
  <div class="card shadow-sm mb-4" style="border-radius: 15px;">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-file text-primary"></i> Files
      </h5>
      {% if files %}
        <ul class="list-group list-group-flush">
          {% for file in files %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="flex-grow-1">
                <i class="fas fa-file-alt text-muted me-2"></i>
                <a href="{% url 'view_edit_file' project.id file.id %}">{{ file.name }}</a>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-secondary">{{ file.size|filesizeformat }}</span>
                
                {% comment %} Open file button {% endcomment %}
                <a href="{% url 'view_edit_file' project.id file.id %}" 
                  class="btn btn-sm btn-primary" 
                  style="border-radius: 8px;"
                  title="Open file">
                  <i class="fas fa-external-link-alt"></i>
                </a>
                
                {% comment %} Download button {% endcomment %}
                <a href="{{ file.file.url }}" 
                  download 
                  class="btn btn-sm btn-info" 
                  style="border-radius: 8px;"
                  title="Download file">
                  <i class="fas fa-download"></i>
                </a>
                
                {% comment %} Show delete button if user has permission {% endcomment %}
                {% if project.owner == user or user|has_edit_permission:project and project.allow_collaborators_delete %}
                <button type="button" 
                        class="btn btn-sm btn-danger" 
                        onclick="showDeleteModal('{{ file.id }}', '{{ file.name }}')"
                        style="border-radius: 8px;"
                        title="Delete file">
                  <i class="fas fa-trash"></i>
                </button>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No files uploaded yet.</p>
      {% endif %}
      
      <!-- Show upload buttons for owner and users with edit permission -->
      {% if project.owner == user or user|has_edit_permission:project %}
      <div class="d-flex justify-content-between align-items-center mt-3 gap-2 flex-wrap">
        <!-- Upload Files Button -->
        <a href="{% url 'upload_file' project.id %}" class="btn btn-primary btn-sm" style="border-radius: 12px;">
          <i class="fas fa-upload"></i> Upload Files
        </a>
        
        <!-- Upload Version Button -->
        <a href="{% url 'upload_version' project.id %}" class="btn btn-success btn-sm" style="border-radius: 12px;">
          <i class="fas fa-code-branch"></i> Upload New Version
        </a>
        
        {% comment %} Delete permission toggle - only for owner {% endcomment %}
        {% if project.owner == user %}
        <form method="POST" action="{% url 'toggle_delete_permission' project.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-secondary" style="border-radius: 12px;">
            {% if project.allow_collaborators_delete %}
              <i class="fas fa-lock-open"></i> Collaborators Can Delete
            {% else %}
              <i class="fas fa-lock"></i> Only Owner Can Delete
            {% endif %}
          </button>
        </form>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Comments Section -->
  <div class="card shadow-sm mb-4" style="border-radius: 15px;">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-comments text-primary"></i> Comments
      </h5>
      {% if comments %}
        <ul class="list-group list-group-flush mb-3">
          {% for comment in comments %}
            <li class="list-group-item">
              <div class="d-flex align-items-start gap-2">
                <div class="user-avatar-small">
                  {{ comment.author.first_name.0|upper }}
                </div>
                <div class="flex-grow-1">
                  <strong>{{ comment.author.username }}</strong>
                  <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                  <p class="mb-0 mt-1">{{ comment.content }}</p>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No comments yet. Be the first to comment!</p>
      {% endif %}

      <!-- Add comment form -->
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <textarea name="text" rows="3" class="form-control" placeholder="Write a comment..." style="border-radius: 12px;" required></textarea>
        </div>
        <button type="submit" class="btn btn-success" style="border-radius: 12px;">
          <i class="fas fa-paper-plane"></i> Post Comment
        </button>
      </form>
    </div>
  </div>

  <!-- Version History Section -->
<div class="card shadow-sm mb-4" style="border-radius: 15px;">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">
        <i class="fas fa-history text-primary"></i> Version History
      </h5>
      {% if versions %}
      <a href="{% url 'version_history' project.id %}" class="btn btn-sm btn-outline-primary" style="border-radius: 8px;">
        <i class="fas fa-list"></i> View All
      </a>
      {% endif %}
    </div>

    {% if versions %}
      <div class="version-timeline">
        {% for version in versions %}
        <div class="version-item" style="border-left: 3px solid #667eea; padding-left: 20px; margin-bottom: 20px; position: relative;">
          <div class="version-marker" style="position: absolute; left: -8px; width: 14px; height: 14px; background: #667eea; border-radius: 50%; border: 3px solid white;"></div>
          
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge bg-primary" style="border-radius: 8px;">{{ version.version_number }}</span>
                {% if forloop.first %}
                <span class="badge bg-success" style="border-radius: 8px;">
                  <i class="fas fa-star"></i> LATEST
                </span>
                {% endif %}
                <span class="version-action" style="color: #0d6efd; font-weight: 600;">{{ version.get_action_display }}</span>
              </div>
              
              <p class="text-muted small mb-1">
                <i class="fas fa-user"></i> {{ version.created_by.username }}
                <span class="mx-2">â€¢</span>
                <i class="fas fa-clock"></i> {{ version.created_at|timesince }} ago
              </p>
              
              {% if version.description %}
              <p class="mb-2 small">{{ version.description }}</p>
              {% endif %}
              
              {% if version.files_snapshot.total_files %}
              <p class="text-muted small mb-0">
                <i class="fas fa-file"></i> {{ version.files_snapshot.total_files }} file(s)
              </p>
              {% endif %}
            </div>
            
            <div class="btn-group" role="group">
              <a href="{% url 'view_version' project.id version.id %}" 
                class="btn btn-sm btn-outline-secondary" 
                style="border-radius: 8px 0 0 8px;"
                title="View version details">
                <i class="fas fa-eye"></i>
              </a>
              
              {% if project.owner == user %}
              <form method="POST" action="{% url 'restore_version' project.id version.id %}" style="display: inline; margin: 0;">
                {% csrf_token %}
                <button type="submit" 
                        class="btn btn-sm btn-primary" 
                        style="border-radius: 0 8px 8px 0;"
                        title="Restore to this version"
                        onclick="return confirm('Are you sure you want to restore to {{ version.version_number }}?\n\nThis will create a new version based on the selected one.')">
                  <i class="fas fa-undo"></i>
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if project.versions.count > versions|length %}
      <div class="text-center mt-3">
        <a href="{% url 'version_history' project.id %}" class="btn btn-sm btn-primary" style="border-radius: 10px;">
          <i class="fas fa-history"></i> View All {{ project.versions.count }} Versions
        </a>
      </div>
      {% endif %}
    {% else %}
      <div class="alert alert-info" style="border-radius: 12px;">
        <i class="fas fa-info-circle"></i> No version history yet. Versions are automatically created when you make changes to your project.
      </div>
    {% endif %}
  </div>
</div>
</div>

<style>
  .cs-button-6 {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .cs-button-6:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    color: white;
    text-decoration: none;
  }
  
  .cs-button-6 .cs-icon {
    transition: transform 0.3s ease;
  }
  
  .cs-button-6:hover .cs-icon {
    transform: rotate(180deg) translateX(4px);
  }

  /* Styles for share section */
  .project-header-card {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 1.5rem;
  }

  .project-meta {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
  }

  .user-avatar-small {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    flex-shrink: 0;
  }

  .shared-users-list .list-group-item {
    border: 1px solid #e5e5e5;
  }

  .card {
    border: none;
  }

  .card-title {
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .version-timeline {
  position: relative;
}

.version-item {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.version-action {
  font-weight: 500;
  color: #333;
}

.version-item:hover {
  background: #f8f9fa;
  border-radius: 8px;
  margin-left: -10px;
  padding-left: 30px !important;
  transition: all 0.2s ease;
}

.share-section {
    transition: all 0.4s ease;
}

.share-section:hover {
    transform: translateY(-4px);
}

.input-group .form-control {
    border-right: none;
}

.input-group .btn {
    border-left: none;
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border: none;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    border: none;
    transition: all 0.3s ease;
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4);
}
</style>

<script>
function copyShareLink(event) {
  const linkInput = document.getElementById('shareableLink');
  linkInput.select();
  linkInput.setSelectionRange(0, 99999); // For mobile devices
  
  navigator.clipboard.writeText(linkInput.value).then(function() {
    // Show success feedback
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.remove('btn-success');
    button.classList.add('btn-primary');
    
    setTimeout(function() {
      button.innerHTML = originalHTML;
      button.classList.remove('btn-primary');
      button.classList.add('btn-success');
    }, 2000);
  }).catch(function(err) {
    alert('Failed to copy link: ' + err);
  });
}

function restoreVersion(projectId, versionId, versionNumber) {
  if (confirm(`Are you sure you want to restore to ${versionNumber}?\n\nThis will create a new version based on the selected one.`)) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/projects/${projectId}/versions/${versionId}/restore/`;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

function showDeleteModal(fileId, fileName) {
  document.getElementById('deleteFileName').textContent = fileName;
  
  // Set the form action URL
  const form = document.getElementById('deleteFileForm');
  form.action = `/projects/{{ project.id }}/files/${fileId}/delete/`;
  
  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById('deleteFileModal'));
  modal.show();
}
</script>

<!-- Delete File Modal -->
<div class="modal fade" id="deleteFileModal" tabindex="-1" aria-labelledby="deleteFileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border-radius: 15px 15px 0 0;">
        <h5 class="modal-title" id="deleteFileModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <p class="mb-3">Are you sure you want to delete this file?</p>
        <div class="alert alert-warning" role="alert" style="border-radius: 10px;">
          <strong>File:</strong> <span id="deleteFileName"></span>
        </div>
        <p class="text-muted small mb-0">
          <i class="fas fa-info-circle"></i> This action cannot be undone. A new version will be created.
        </p>
      </div>
      <div class="modal-footer" style="border-top: none; padding: 1rem 2rem 2rem 2rem;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">
          <i class="fas fa-times"></i> Cancel
        </button>
        <form id="deleteFileForm" method="POST" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger" style="border-radius: 10px;">
            <i class="fas fa-trash"></i> Delete File
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}