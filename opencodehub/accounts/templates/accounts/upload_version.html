{% extends 'accounts/base.html' %}

{% block title %}Upload New Version - OpenCodeHub{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'project_detail' project.id %}" class="cs-button-6">
            <svg class="cs-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg);">
                <path d="M17.92 11.62C17.8724 11.4973 17.801 11.3851 17.71 11.29L12.71 6.29C12.6168 6.19676 12.5061 6.1228 12.3842 6.07234C12.2624 6.02188 12.1319 5.99591 12 5.99591C11.7337 5.99591 11.4783 6.1017 11.29 6.29C11.1968 6.38324 11.1228 6.49393 11.0723 6.61575C11.0219 6.73758 10.9959 6.86814 10.9959 7C10.9959 7.2663 11.1017 7.5217 11.29 7.71L14.59 11H7C6.73478 11 6.48043 11.1054 6.29289 11.2929C6.10536 11.4804 6 11.7348 6 12C6 12.2652 6.10536 12.5196 6.29289 12.7071C6.48043 12.8946 6.73478 13 7 13H14.59L11.29 16.29C11.1963 16.383 11.1219 16.4936 11.0711 16.6154C11.0203 16.7373 10.9942 16.868 10.9942 17C10.9942 17.132 11.0203 17.2627 11.0711 17.3846C11.1219 17.5064 11.1963 17.617 11.29 17.71C11.383 17.8037 11.4936 17.8781 11.6154 17.9289C11.7373 17.9797 11.868 18.0058 12 18.0058C12.132 18.0058 12.2627 17.9797 12.3846 17.9289C12.5064 17.8781 12.617 17.8037 12.71 17.71L17.71 12.71C17.801 12.6149 17.8724 12.5028 17.92 12.38C18.02 12.1365 18.02 11.8635 17.92 11.62Z" fill="currentColor"/>
            </svg>
            Back to Project
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0" style="border-radius: 20px;">
                <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0;">
                    <h2 class="mb-0">
                        <i class="fas fa-code-branch"></i> Upload New Version
                    </h2>
                    <p class="mb-0 mt-2" style="opacity: 0.9;">{{ project.title }}</p>
                </div>

                <div class="card-body p-5">
                    <!-- Info Alert -->
                    <div class="alert alert-info" style="border-radius: 12px;">
                        <i class="fas fa-info-circle"></i>
                        <strong>What is a version?</strong> A version is a snapshot of your entire project at a specific point in time. 
                        Upload a ZIP file containing all your project files for this version.
                    </div>

                    <!-- Next Version Number Display -->
                    <div class="alert alert-success" style="border-radius: 12px;">
                        <i class="fas fa-tag"></i>
                        <strong>Next version number:</strong> <code>{{ next_version }}</code>
                    </div>

                    <!-- Upload Form -->
                    <form method="POST" enctype="multipart/form-data" id="versionUploadForm">
                        {% csrf_token %}

                        <!-- Version Number (Auto-filled but editable) -->
                        <div class="mb-4">
                            <label for="version_number" class="form-label">
                                <i class="fas fa-hashtag text-primary"></i> Version Number
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="version_number" 
                                   name="version_number" 
                                   value="{{ next_version }}"
                                   placeholder="e.g., v1, v2.0, v1.5.3"
                                   required
                                   style="border-radius: 12px;">
                            <small class="form-text text-muted">
                                You can customize the version number (e.g., v1.0, v2.5, beta-1)
                            </small>
                        </div>

                        <!-- Version Description -->
                        <div class="mb-4">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left text-primary"></i> Description
                            </label>
                            <textarea class="form-control" 
                                      id="description" 
                                      name="description" 
                                      rows="4" 
                                      placeholder="Describe what's new in this version..."
                                      style="border-radius: 12px;"></textarea>
                            <small class="form-text text-muted">
                                Optional: Describe changes, new features, or bug fixes
                            </small>
                        </div>

                        <!-- File Upload -->
                        <div class="mb-4">
                            <label for="version_file" class="form-label">
                                <i class="fas fa-file-archive text-primary"></i> Version File *
                            </label>
                            <input type="file" 
                                   class="form-control" 
                                   id="version_file" 
                                   name="version_file" 
                                   required
                                   accept=".zip,.rar,.7z,.tar,.gz"
                                   style="border-radius: 12px;">
                            <small class="form-text text-muted">
                                Upload a ZIP or archive file containing your project files (Max 50MB)
                            </small>
                        </div>

                        <!-- Mark as Latest -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="is_latest" 
                                       name="is_latest"
                                       checked>
                                <label class="form-check-label" for="is_latest">
                                    <i class="fas fa-star text-warning"></i> Mark as latest version
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                The latest version is highlighted and shown first
                            </small>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" style="border-radius: 12px;">
                                <i class="fas fa-upload"></i> Upload Version
                            </button>
                            <a href="{% url 'project_detail' project.id %}" 
                               class="btn btn-outline-secondary" 
                               style="border-radius: 12px;">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card mt-4 shadow-sm" style="border-radius: 15px;">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-question-circle text-info"></i> How to create a version file
                    </h5>
                    <ol class="mb-0">
                        <li class="mb-2">Collect all your project files in one folder</li>
                        <li class="mb-2">Right-click the folder and select "Compress" or "Send to â†’ Compressed (zipped) folder"</li>
                        <li class="mb-2">Name the ZIP file (e.g., "MyProject_v1.0.zip")</li>
                        <li>Upload the ZIP file using the form above</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .cs-button-6 {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .cs-button-6:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        color: white;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .card {
        border: none;
    }
</style>

<script>
    // Show file name when selected
    document.getElementById('version_file').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        if (fileName) {
            console.log('Selected file:', fileName);
        }
    });

    // Form validation
    document.getElementById('versionUploadForm').addEventListener('submit', function(e) {
        const versionNumber = document.getElementById('version_number').value.trim();
        const versionFile = document.getElementById('version_file').files[0];

        if (!versionNumber) {
            alert('Please enter a version number');
            e.preventDefault();
            return;
        }

        if (!versionFile) {
            alert('Please select a file to upload');
            e.preventDefault();
            return;
        }

        // Check file size (50MB)
        const maxSize = 50 * 1024 * 1024; // 50MB in bytes
        if (versionFile.size > maxSize) {
            alert(`File size (${(versionFile.size / (1024*1024)).toFixed(1)}MB) exceeds maximum allowed size of 50MB`);
            e.preventDefault();
            return;
        }
    });
</script>
{% endblock %}