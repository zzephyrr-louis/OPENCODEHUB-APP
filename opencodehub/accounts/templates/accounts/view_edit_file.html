{% extends 'accounts/base.html' %}
{% block content %}
<div class="container mt-4">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'project_detail' project.id %}" class="cs-button-6">
        <svg class="cs-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg);">
            <path d="M17.92 11.62C17.8724 11.4973 17.801 11.3851 17.71 11.29L12.71 6.29C12.6168 6.19676 12.5061 6.1228 12.3842 6.07234C12.2624 6.02188 12.1319 5.99591 12 5.99591C11.7337 5.99591 11.4783 6.1017 11.29 6.29C11.1968 6.38324 11.1228 6.49393 11.0723 6.61575C11.0219 6.73758 10.9959 6.86814 10.9959 7C10.9959 7.2663 11.1017 7.5217 11.29 7.71L14.59 11H7C6.73478 11 6.48043 11.1054 6.29289 11.2929C6.10536 11.4804 6 11.7348 6 12C6 12.2652 6.10536 12.5196 6.29289 12.7071C6.48043 12.8946 6.73478 13 7 13H14.59L11.29 16.29C11.1963 16.383 11.1219 16.4936 11.0711 16.6154C11.0203 16.7373 10.9942 16.868 10.9942 17C10.9942 17.132 11.0203 17.2627 11.0711 17.3846C11.1219 17.5064 11.1963 17.617 11.29 17.71C11.383 17.8037 11.4936 17.8781 11.6154 17.9289C11.7373 17.9797 11.868 18.0058 12 18.0058C12.132 18.0058 12.2627 17.9797 12.3846 17.9289C12.5064 17.8781 12.617 17.8037 12.71 17.71L17.71 12.71C17.801 12.6149 17.8724 12.5028 17.92 12.38C18.02 12.1365 18.02 11.8635 17.92 11.62Z" fill="currentColor"/>
        </svg>
        Back to Project
        </a>
    </div>

    <!-- File Header -->
    <div class="file-header-card mb-4">
        <div class="d-flex justify-content-between align-items-start">
        <div>
            <h2>
            {% if file_type == 'word' %}
                <i class="fas fa-file-word text-primary"></i>
            {% elif file_type == 'excel' %}
                <i class="fas fa-file-excel text-success"></i>
            {% else %}
                <i class="fas fa-file-code text-primary"></i>
            {% endif %}
            {{ file.name }}
            </h2>
            <p class="text-muted mb-2">{{ project.title }}</p>
            <div class="file-meta">
            <span class="badge bg-secondary">
                <i class="fas fa-tag"></i> {{ file.file_type|upper }}
            </span>
            <span class="badge bg-info">
                <i class="fas fa-hdd"></i> {{ file.size|filesizeformat }}
            </span>
            {% if is_editable %}
            <span class="badge bg-success">
                <i class="fas fa-edit"></i> Editable
            </span>
            {% else %}
            <span class="badge bg-warning">
                <i class="fas fa-eye"></i> View Only
            </span>
            {% endif %}
            </div>
        </div>
        
        <a href="{{ file.file.url }}" download class="btn btn-primary" style="border-radius: 12px;">
            <i class="fas fa-download"></i> Download
        </a>
        </div>
    </div>

    <!-- File Content -->
    {% if is_editable %}
    
        {% if file_type == 'text' %}
        <!-- TEXT EDITOR -->
        <div class="card shadow-sm" style="border-radius: 15px;">
        <div class="card-body p-0">
            <form method="POST" id="editFileForm">
            {% csrf_token %}
            <div class="editor-header" style="background: #f8f9fa; padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; border-radius: 15px 15px 0 0;">
                <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-code"></i> Text Editor
                </h5>
                {% if can_edit %}
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetContent()" style="border-radius: 8px 0 0 8px;">
                    <i class="fas fa-undo"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-sm btn-success" style="border-radius: 0 8px 8px 0;">
                    <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                {% endif %}
                </div>
            </div>
            
            <textarea 
                name="content" 
                id="fileContent" 
                class="form-control" 
                style="border: none; border-radius: 0 0 15px 15px; font-family: 'Courier New', monospace; font-size: 14px; min-height: 500px;"
                {% if not can_edit %}readonly{% endif %}
            >{{ file_content }}</textarea>
            </form>
        </div>
        </div>
        
        {% elif file_type == 'word' %}
        <!-- WORD EDITOR -->
        <div class="card shadow-sm" style="border-radius: 15px;">
        <div class="card-body p-0">
            <form method="POST" id="editFileForm">
            {% csrf_token %}
            <div class="editor-header" style="background: #2b579a; padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; border-radius: 15px 15px 0 0;">
                <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0" style="color: white;">
                    <i class="fas fa-file-word"></i> Word Document Editor
                </h5>
                {% if can_edit %}
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-light" onclick="resetContent()" style="border-radius: 8px 0 0 8px;">
                    <i class="fas fa-undo"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-sm btn-success" style="border-radius: 0 8px 8px 0;">
                    <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                {% endif %}
                </div>
            </div>
            
            <div id="wordEditor" 
                contenteditable="{% if can_edit %}true{% else %}false{% endif %}"
                class="p-4"
                style="min-height: 500px; background: white; border-radius: 0 0 15px 15px; outline: none;">
                {{ file_content|safe }}
            </div>
            
            <input type="hidden" name="content" id="wordContent">
            </form>
        </div>
        </div>
        
        {% elif file_type == 'excel' %}
        <!-- EXCEL EDITOR -->
        <div class="card shadow-sm" style="border-radius: 15px;">
        <div class="card-body p-0">
            <form method="POST" id="editFileForm">
            {% csrf_token %}
            
            <!-- Added row/column count display -->
            <div class="editor-header" style="background: #217346; padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; border-radius: 15px 15px 0 0;">
                <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0" style="color: white;">
                    <i class="fas fa-file-excel"></i> Excel Spreadsheet Editor
                    <!-- Shows dimensions of spreadsheet -->
                    <small style="opacity: 0.8; font-size: 0.85rem; margin-left: 1rem;">
                        {{ excel_data.headers|length }} columns Ã— {{ excel_data.rows|length }} rows
                    </small>
                </h5>
                {% if can_edit %}
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-light" onclick="addRow()" style="border-radius: 8px 0 0 0;">
                    <i class="fas fa-plus"></i> Add Row
                    </button>
                    <button type="button" class="btn btn-sm btn-light" onclick="addColumn()" style="border-radius: 0;">
                    <i class="fas fa-plus"></i> Add Column
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="resetExcel()" style="border-radius: 0;">
                    <i class="fas fa-undo"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-sm btn-success" style="border-radius: 0 8px 8px 0;">
                    <i class="fas fa-save"></i> Save
                    </button>
                </div>
                {% endif %}
                </div>
            </div>
            
            <!-- Added max-height, better overflow handling, and scrollable container -->
            <div class="table-responsive p-3" style="background: white; border-radius: 0 0 15px 15px; max-height: 600px; overflow: auto;">
                <!-- Check if headers exist before displaying table -->
                {% if excel_data.headers %}
                <table class="table table-bordered" id="excelTable" style="margin-bottom: 0;">
                <!-- Made headers sticky so they stay visible when scrolling -->
                <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                    <tr id="headerRow">
                    {% for header in excel_data.headers %}
                    <!-- Added min-width to prevent cramped columns -->
                    <th contenteditable="{% if can_edit %}true{% else %}false{% endif %}" class="excel-cell" style="min-width: 150px;">{{ header }}</th>
                    {% endfor %}
                    <!-- Empty header cell for delete button column -->
                    {% if can_edit %}
                    <th style="width: 50px; background: #f8f9fa;"></th>
                    {% endif %}
                    </tr>
                </thead>
                <tbody id="excelBody">
                    <!-- Check if rows exist -->
                    {% if excel_data.rows %}
                        {% for row in excel_data.rows %}
                        <tr>
                        {% for cell in row %}
                        <td contenteditable="{% if can_edit %}true{% else %}false{% endif %}" class="excel-cell">{{ cell }}</td>
                        {% endfor %}
                        {% if can_edit %}
                        <!-- Better vertical alignment for delete button -->
                        <td class="text-center" style="background: #f8f9fa; vertical-align: middle;">
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteRow(this)">
                            <i class="fas fa-times"></i>
                            </button>
                        </td>
                        {% endif %}
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- Message when no data rows exist -->
                        <tr>
                            <td colspan="{{ excel_data.headers|length }}" class="text-center text-muted py-4">
                                <i class="fas fa-table"></i> No data rows. Click "Add Row" to start adding data.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
                </table>
                {% else %}
                <!-- Warning message if file couldn't be read -->
                <div class="alert alert-warning m-3">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>No data found in this Excel file.</strong>
                    The file may be empty or could not be read properly.
                </div>
                {% endif %}
            </div>
            
            <input type="hidden" name="excel_data" id="excelData">
            </form>
        </div>
        </div>
        <!-- END EXCEL EDITOR -->
        {% endif %}
        
        {% if can_edit %}
        <div class="alert alert-info mt-3" style="border-radius: 12px;">
        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Changes will create a new version in the project history.
        </div>
        {% endif %}
    
    {% else %}
    <!-- Non-editable file message -->
    <div class="card shadow-sm" style="border-radius: 15px;">
        <div class="card-body text-center py-5">
        <i class="fas fa-file" style="font-size: 4rem; color: #ddd;"></i>
        <h4 class="mt-3 mb-2">Cannot Preview This File</h4>
        <p class="text-muted">This file type ({{ file.file_type|upper }}) cannot be edited in the browser.</p>
        <p class="text-muted small">Please download the file to view or edit it locally.</p>
        <a href="{{ file.file.url }}" download class="btn btn-primary mt-3" style="border-radius: 12px;">
            <i class="fas fa-download"></i> Download File
        </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .cs-button-6 {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .cs-button-6:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        color: white;
    }

    .file-header-card {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .file-meta {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .card {
        border: none;
    }

    #fileContent {
        resize: vertical;
    }

    #wordEditor {
        font-family: 'Times New Roman', serif;
        font-size: 12pt;
        line-height: 1.6;
    }

    /* EXCEL CELL STYLES */
    .excel-cell {
        min-width: 120px;           // Increased from 100px 
        max-width: 300px;           // Prevents cells from being too wide
        padding: 8px 12px;          // Better padding 
        white-space: pre-wrap;      // Preserves line breaks 
        word-wrap: break-word;      // Breaks long words 
        vertical-align: top;        // Aligns content to top 
    }

    .excel-cell:focus {
        background: #e3f2fd;
        outline: 2px solid #2196f3;
        outline-offset: -2px;       // Keeps outline inside cell 
    }

    #excelTable {
        margin-bottom: 0;
        font-size: 14px;            // Consistent font size
    }

    // Better header styling
    #excelTable thead th {
        background: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    // Sticky header for scrolling
    .table-responsive {
        position: relative;
    }

    // Better scrollbar styling 
    .table-responsive::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script>
{% if file_type == 'text' %}
const originalContent = `{{ file_content|escapejs }}`;

function resetContent() {
    if (confirm('Are you sure you want to reset all changes?')) {
        document.getElementById('fileContent').value = originalContent;
    }
}
{% endif %}

{% if file_type == 'word' %}
const originalWordContent = `{{ file_content|escapejs }}`;

function resetContent() {
    if (confirm('Are you sure you want to reset all changes?')) {
        document.getElementById('wordEditor').innerHTML = originalWordContent;
    }
}

// Capture Word editor content before submit
document.getElementById('editFileForm').addEventListener('submit', function(e) {
    const editorContent = document.getElementById('wordEditor').innerHTML;
    document.getElementById('wordContent').value = editorContent;
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
});
{% endif %}

{% if file_type == 'excel' %}
// Excel data as JSON
const originalExcelData = {{ excel_data|safe }};

function addRow() { 
    const tbody = document.getElementById('excelBody');
    const headerRow = document.getElementById('headerRow');
    const colCount = headerRow.querySelectorAll('.excel-cell').length;
    
    const newRow = tbody.insertRow();
    for (let i = 0; i < colCount; i++) {
        const cell = newRow.insertCell();
        cell.contentEditable = 'true';
        cell.className = 'excel-cell';
        cell.textContent = '';
    }
    
    // Add delete button
    const deleteCell = newRow.insertCell();
    deleteCell.className = 'text-center';
    deleteCell.style.background = '#f8f9fa';
    deleteCell.innerHTML = '<button type="button" class="btn btn-sm btn-danger" onclick="deleteRow(this)"><i class="fas fa-times"></i></button>';
}

function addColumn() {
    const table = document.getElementById('excelTable');
    const headerRow = document.getElementById('headerRow');
    
    const currentCols = headerRow.querySelectorAll('.excel-cell').length;
    const newColNum = currentCols + 1;
    
    const th = document.createElement('th');
    th.contentEditable = 'true';
    th.className = 'excel-cell';
    th.style.minWidth = '150px';
    th.textContent = `Column ${newColNum}`;
    
    const lastHeaderCell = headerRow.lastElementChild;
    if (lastHeaderCell && !lastHeaderCell.classList.contains('excel-cell')) {
        headerRow.insertBefore(th, lastHeaderCell);
    } else {
        headerRow.appendChild(th);
    }
    
    const rows = document.getElementById('excelBody').rows;
    for (let row of rows) {
        const deleteButtonCell = row.querySelector('td[style*="background: #f8f9fa"]');
        
        const cell = document.createElement('td');
        cell.contentEditable = 'true';
        cell.className = 'excel-cell';
        cell.textContent = '';
        
        if (deleteButtonCell) {
            row.insertBefore(cell, deleteButtonCell);
        } else {
            row.appendChild(cell);
        }
    }
}

function deleteRow(btn) {
    if (confirm('Delete this row?')) {
        btn.closest('tr').remove();
    }
}

function resetExcel() {
    if (confirm('Are you sure you want to reset all changes?')) {
        location.reload();
    }
}

// Capture Excel data before submit
document.getElementById('editFileForm').addEventListener('submit', function(e) {
    const headers = [];
    const rows = [];
    
    // Get headers
    const headerCells = document.querySelectorAll('#headerRow .excel-cell');
    headerCells.forEach(cell => headers.push(cell.textContent.trim()));
    
    // Get rows
    const bodyRows = document.querySelectorAll('#excelBody tr');
    bodyRows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('.excel-cell');
        cells.forEach(cell => rowData.push(cell.textContent.trim()));
        if (rowData.length > 0) {
            rows.push(rowData);
        }
    });
    
    const excelData = {
        headers: headers,
        rows: rows
    };
    
    document.getElementById('excelData').value = JSON.stringify(excelData);
    
    const submitBtn = this.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    }
});

console.log('Excel editor initialized with', originalExcelData);
{% endif %}
</script>
{% endblock %}